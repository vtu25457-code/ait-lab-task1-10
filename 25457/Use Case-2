import pandas as pd
import numpy as np
from keras.models import Sequential
from keras.layers import LSTM, Dense, Dropout
from sklearn.preprocessing import MinMaxScaler
import matplotlib.pyplot as plt

# Read data
df = pd.read_csv('NSE-TATA.csv')
df['Date'] = pd.to_datetime(df['Date'], format='%Y-%m-%d')
df.index = df['Date']

# Prepare dataset
data = df.sort_index(ascending=True)
new_dataset = pd.DataFrame(index=range(0, len(df)), columns=['Date', 'Close'])
for i in range(0, len(data)):
    new_dataset['Date'][i] = data['Date'][i]
    new_dataset['Close'][i] = data['Close'][i]

# Normalize data
scaler = MinMaxScaler(feature_range=(0,1))
final_dataset = new_dataset['Close'].values.reshape(-1,1)
scaled_data = scaler.fit_transform(final_dataset)

# Create training data
train_data = scaled_data[0:int(len(df)*0.8), :]
x_train, y_train = [], []
for i in range(60, len(train_data)):
    x_train.append(train_data[i-60:i,0])
    y_train.append(train_data[i,0])
x_train, y_train = np.array(x_train), np.array(y_train)
x_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))

# Build LSTM model
model = Sequential()
model.add(LSTM(units=50, return_sequences=True, input_shape=(x_train.shape[1], 1)))
model.add(LSTM(units=50))
model.add(Dense(1))
model.compile(loss='mean_squared_error', optimizer='adam')

# Train
model.fit(x_train, y_train, epochs=10, batch_size=32, verbose=2)

# Predict
inputs = scaled_data[len(scaled_data)-len(new_dataset):]
X_test = []
for i in range(60, inputs.shape[0]):
    X_test.append(inputs[i-60:i,0])
X_test = np.array(X_test)
X_test = np.reshape(X_test, (X_test.shape[0], X_test.shape[1], 1))
closing_price = model.predict(X_test)
closing_price = scaler.inverse_transform(closing_price)

# Plot results
plt.plot(new_dataset['Close'], label='True Price')
plt.plot(range(60,60+len(closing_price)), closing_price, label='Predicted Price')
plt.legend()
plt.show()
